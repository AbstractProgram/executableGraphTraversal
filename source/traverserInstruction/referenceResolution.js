"use strict";Object.defineProperty(exports, "__esModule", { value: true });exports.resolveReference = resolveReference;exports.selectionReferenceResolution = selectionReferenceResolution;exports.conditionSwitchResolution = conditionSwitchResolution;var _valueResolution = require("./valueResolution.js");
var _concreteDatabaseWrapper = require("../dataModel/concreteDatabaseWrapper.js");


async function resolveReference({ targetNode, graphInstance, traverseCallContext }) {
  const { reference } = await graphInstance.databaseWrapper.getReferenceResolutionElement({ concreteDatabase: graphInstance.database, nodeID: targetNode.identity });
  if (!reference) return;


  if ((0, _concreteDatabaseWrapper.isSelfEdge)(reference)) {

    let labelIndex = reference.destination.labels.indexOf(targetNode.entrypointNodeType);
    reference.destination.labels[labelIndex] += `-ignore`;
  }

  let resolvedNode;
  switch (reference.connection.properties.resolutionImplementation) {
    case 'selection':
      resolvedNode = await selectionReferenceResolution({ graphInstance, targetNode: reference.destination, traverseCallContext });
      break;
    case 'node':
    default:
      resolvedNode = reference.destination;
      break;}


  return resolvedNode;
}




async function selectionReferenceResolution({ graphInstance, targetNode, traverseCallContext }) {
  let resolvedReferenceNode;
  const { selectArray, fallback: fallbackRelationship } = await graphInstance.databaseWrapper.getSelectionElement({ concreteDatabase: graphInstance.database, nodeID: targetNode.identity });
  selectArray.sort((former, latter) => former.connection.properties.order - latter.connection.properties.order);

  let index = 0;
  while (selectArray.length > index && !resolvedReferenceNode) {
    resolvedReferenceNode = await conditionSwitchResolution({ graphInstance, targetNode: selectArray[index].destination, traverseCallContext });
    index++;
  }

  resolvedReferenceNode || (resolvedReferenceNode = fallbackRelationship === null || fallbackRelationship === void 0 ? void 0 : fallbackRelationship.destination);
  return resolvedReferenceNode || null;
}





async function conditionSwitchResolution({ graphInstance, targetNode, traverseCallContext }) {
  let matchingNode;
  const { caseArray } = await graphInstance.databaseWrapper.getConditionSwitchElement({ concreteDatabase: graphInstance.database, nodeID: targetNode.identity });
  let value = await (0, _valueResolution.resolveValue)({ targetNode: targetNode, graphInstance, traverseCallContext });

  if (caseArray) {

    let caseRelationship = caseArray.filter(caseRelationship => {var _caseRelationship$con;return ((_caseRelationship$con = caseRelationship.connection.properties) === null || _caseRelationship$con === void 0 ? void 0 : _caseRelationship$con.expected) == value;})[0];
    matchingNode = caseRelationship === null || caseRelationship === void 0 ? void 0 : caseRelationship.destination;
  }
  return matchingNode || null;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NvdXJjZS90cmF2ZXJzZXJJbnN0cnVjdGlvbi9yZWZlcmVuY2VSZXNvbHV0aW9uLmpzIl0sIm5hbWVzIjpbInJlc29sdmVSZWZlcmVuY2UiLCJ0YXJnZXROb2RlIiwiZ3JhcGhJbnN0YW5jZSIsInRyYXZlcnNlQ2FsbENvbnRleHQiLCJyZWZlcmVuY2UiLCJkYXRhYmFzZVdyYXBwZXIiLCJnZXRSZWZlcmVuY2VSZXNvbHV0aW9uRWxlbWVudCIsImNvbmNyZXRlRGF0YWJhc2UiLCJkYXRhYmFzZSIsIm5vZGVJRCIsImlkZW50aXR5IiwibGFiZWxJbmRleCIsImRlc3RpbmF0aW9uIiwibGFiZWxzIiwiaW5kZXhPZiIsImVudHJ5cG9pbnROb2RlVHlwZSIsInJlc29sdmVkTm9kZSIsImNvbm5lY3Rpb24iLCJwcm9wZXJ0aWVzIiwicmVzb2x1dGlvbkltcGxlbWVudGF0aW9uIiwic2VsZWN0aW9uUmVmZXJlbmNlUmVzb2x1dGlvbiIsInJlc29sdmVkUmVmZXJlbmNlTm9kZSIsInNlbGVjdEFycmF5IiwiZmFsbGJhY2siLCJmYWxsYmFja1JlbGF0aW9uc2hpcCIsImdldFNlbGVjdGlvbkVsZW1lbnQiLCJzb3J0IiwiZm9ybWVyIiwibGF0dGVyIiwib3JkZXIiLCJpbmRleCIsImxlbmd0aCIsImNvbmRpdGlvblN3aXRjaFJlc29sdXRpb24iLCJtYXRjaGluZ05vZGUiLCJjYXNlQXJyYXkiLCJnZXRDb25kaXRpb25Td2l0Y2hFbGVtZW50IiwidmFsdWUiLCJjYXNlUmVsYXRpb25zaGlwIiwiZmlsdGVyIiwiZXhwZWN0ZWQiXSwibWFwcGluZ3MiOiJ5UEFBQTtBQUNBOzs7QUFHTyxlQUFlQSxnQkFBZixDQUFnQyxFQUFFQyxVQUFGLEVBQWNDLGFBQWQsRUFBNkJDLG1CQUE3QixFQUFoQyxFQUFvRjtBQUN6RixRQUFNLEVBQUVDLFNBQUYsS0FBZ0IsTUFBTUYsYUFBYSxDQUFDRyxlQUFkLENBQThCQyw2QkFBOUIsQ0FBNEQsRUFBRUMsZ0JBQWdCLEVB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Q0ksTUFBVixDQUFpQkQsZ0JBQWdCLHNDQUFJLDBCQUFBQSxnQkFBZ0IsQ0FBQ3BCLFVBQWpCLENBQTRCQyxVQUE1QixnRkFBd0NxQixRQUF4QyxLQUFvREgsS0FBeEQsRUFBakMsRUFBZ0csQ0FBaEcsQ0FBdkI7QUFDQUgsSUFBQUEsWUFBWSxHQUFHSSxnQkFBSCxhQUFHQSxnQkFBSCx1QkFBR0EsZ0JBQWdCLENBQUV6QixXQUFqQztBQUNEO0FBQ0QsU0FBT3FCLFlBQVksSUFBSSxJQUF2QjtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcmVzb2x2ZVZhbHVlIH0gZnJvbSAnLi92YWx1ZVJlc29sdXRpb24uanMnXG5pbXBvcnQgeyBpc1NlbGZFZGdlIH0gZnJvbSAnLi4vZGF0YU1vZGVsL2NvbmNyZXRlRGF0YWJhc2VXcmFwcGVyLmpzJ1xuXG4vLyBSZXNvbHV0aW9uIG9mIHJlZmVyZW5jZSBub2RlIHVzaW5nIGRpZmZlcmVudCBtZWNoYW5pc21zLlxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlc29sdmVSZWZlcmVuY2UoeyB0YXJnZXROb2RlLCBncmFwaEluc3RhbmNlLCB0cmF2ZXJzZUNhbGxDb250ZXh0IH0pIHtcbiAgY29uc3QgeyByZWZlcmVuY2UgfSA9IGF3YWl0IGdyYXBoSW5zdGFuY2UuZGF0YWJhc2VXcmFwcGVyLmdldFJlZmVyZW5jZVJlc29sdXRpb25FbGVtZW50KHsgY29uY3JldGVEYXRhYmFzZTogZ3JhcGhJbnN0YW5jZS5kYXRhYmFzZSwgbm9kZUlEOiB0YXJnZXROb2RlLmlkZW50aXR5IH0pXG4gIGlmICghcmVmZXJlbmNlKSByZXR1cm5cblxuICAvLyBwcmV2ZW50IGNpcmN1bGFyIHRyYXZlcnNhbCwgaW4gY2FzZSBtdWx0aXBsZSB0eXBlcyBhcmUgdXNlZCBmb3IgdGhlIHNhbWUgbm9kZSBhbmQgdGhlIHJlZmVyZW5jZSBlZGdlIGlzIHNlbGYgZWRnZTpcbiAgaWYgKGlzU2VsZkVkZ2UocmVmZXJlbmNlKSkge1xuICAgIC8vIHdvcmthcm91bmQgaXMgdG8gcmVtb3ZlIHRoZSBSZXJvdXRlIHR5cGUgZnJvbSB0aGUgbGFiZWxzIGFycmF5LiBUT0RPOiBjb25zaWRlciBhbGxvd2luZyBhIHBhcmFtZXRlciB0aGF0IGNvbnRyb2xzIHdoaWNoIGVudHJ5cG9pbnQgbm9kZSBpbXBsZW1lbnRhdGlvbnMgYXJlIGlnbm9yZWQuXG4gICAgbGV0IGxhYmVsSW5kZXggPSByZWZlcmVuY2UuZGVzdGluYXRpb24ubGFiZWxzLmluZGV4T2YodGFyZ2V0Tm9kZS5lbnRyeXBvaW50Tm9kZVR5cGUpXG4gICAgcmVmZXJlbmNlLmRlc3RpbmF0aW9uLmxhYmVsc1tsYWJlbEluZGV4XSArPSBgLWlnbm9yZWAgLy8gaWdub3JlIG9uIG5leHQgdHJhdmVyc2FsIChrZWVwIHRoZSBlbnRyeSBmb3IgZGVidWdnaW5nIHB1cnBvc2VzKS5cbiAgfVxuXG4gIGxldCByZXNvbHZlZE5vZGVcbiAgc3dpdGNoIChyZWZlcmVuY2UuY29ubmVjdGlvbi5wcm9wZXJ0aWVzLnJlc29sdXRpb25JbXBsZW1lbnRhdGlvbikge1xuICAgIGNhc2UgJ3NlbGVjdGlvbic6XG4gICAgICByZXNvbHZlZE5vZGUgPSBhd2FpdCBzZWxlY3Rpb25SZWZlcmVuY2VSZXNvbHV0aW9uKHsgZ3JhcGhJbnN0YW5jZSwgdGFyZ2V0Tm9kZTogcmVmZXJlbmNlLmRlc3RpbmF0aW9uLCB0cmF2ZXJzZUNhbGxDb250ZXh0IH0pXG4gICAgICBicmVha1xuICAgIGNhc2UgJ25vZGUnOlxuICAgIGRlZmF1bHQ6XG4gICAgICByZXNvbHZlZE5vZGUgPSByZWZlcmVuY2UuZGVzdGluYXRpb25cbiAgICAgIGJyZWFrXG4gIH1cblxuICByZXR1cm4gcmVzb2x2ZWROb2RlXG59XG5cbi8qKlxuICogQ29udHJvbCBmbG93IHN0cnVjdHVyZSBzdXBwb3J0aW5nIGJpbmFyeSBzZWxlY2F0aW9uIChpZiBzdGF0ZW1lbnQpLCBpZiBlbHNlIGlmLCBzd2l0Y2ggY2FzZSAobXVsdGktd2F5IHNlbGVjdGlvbikuIEEgY29tYmluZWQgSWYgRWxzZSBhbmQgU3dpdGNoIENhc2UgY29uY2VwdHMuXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzZWxlY3Rpb25SZWZlcmVuY2VSZXNvbHV0aW9uKHsgZ3JhcGhJbnN0YW5jZSwgdGFyZ2V0Tm9kZSwgdHJhdmVyc2VDYWxsQ29udGV4dCB9KSB7XG4gIGxldCByZXNvbHZlZFJlZmVyZW5jZU5vZGVcbiAgY29uc3QgeyBzZWxlY3RBcnJheSwgZmFsbGJhY2s6IGZhbGxiYWNrUmVsYXRpb25zaGlwIH0gPSBhd2FpdCBncmFwaEluc3RhbmNlLmRhdGFiYXNlV3JhcHBlci5nZXRTZWxlY3Rpb25FbGVtZW50KHsgY29uY3JldGVEYXRhYmFzZTogZ3JhcGhJbnN0YW5jZS5kYXRhYmFzZSwgbm9kZUlEOiB0YXJnZXROb2RlLmlkZW50aXR5IH0pXG4gIHNlbGVjdEFycmF5LnNvcnQoKGZvcm1lciwgbGF0dGVyKSA9PiBmb3JtZXIuY29ubmVjdGlvbi5wcm9wZXJ0aWVzLm9yZGVyIC0gbGF0dGVyLmNvbm5lY3Rpb24ucHJvcGVydGllcy5vcmRlcikgLy8gdXNpbmcgYG9yZGVyYCBwcm9wZXJ0eSAvLyBCdWxrIGFjdGlvbnMgb24gZm9ya3MgLSBzb3J0IGZvcmtzXG5cbiAgbGV0IGluZGV4ID0gMFxuICB3aGlsZSAoc2VsZWN0QXJyYXkubGVuZ3RoID4gaW5kZXggJiYgIXJlc29sdmVkUmVmZXJlbmNlTm9kZSkge1xuICAgIHJlc29sdmVkUmVmZXJlbmNlTm9kZSA9IGF3YWl0IGNvbmRpdGlvblN3aXRjaFJlc29sdXRpb24oeyBncmFwaEluc3RhbmNlLCB0YXJnZXROb2RlOiBzZWxlY3RBcnJheVtpbmRleF0uZGVzdGluYXRpb24sIHRyYXZlcnNlQ2FsbENvbnRleHQgfSlcbiAgICBpbmRleCsrXG4gIH1cblxuICByZXNvbHZlZFJlZmVyZW5jZU5vZGUgfHw9IGZhbGxiYWNrUmVsYXRpb25zaGlwPy5kZXN0aW5hdGlvblxuICByZXR1cm4gcmVzb2x2ZWRSZWZlcmVuY2VOb2RlIHx8IG51bGxcbn1cblxuLyoqIHJlc29sdmVzIFZBTFVFIGFuZCBwaWNrcyB0aGUgbWF0Y2hpbmcgQ0FTRSBub2RlLlxuICAqIEBwYXJhbSB0YXJnZXROb2RlIFN0YWdlIG5vZGUgd2l0aCBWQUxVRSBjb25uZWN0aW9uIHJlcHJlc2VudGluZyB0aGUgY29uZGl0aW9uXG5cbiovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY29uZGl0aW9uU3dpdGNoUmVzb2x1dGlvbih7IGdyYXBoSW5zdGFuY2UsIHRhcmdldE5vZGUsIHRyYXZlcnNlQ2FsbENvbnRleHQgfSkge1xuICBsZXQgbWF0Y2hpbmdOb2RlXG4gIGNvbnN0IHsgY2FzZUFycmF5IH0gPSBhd2FpdCBncmFwaEluc3RhbmNlLmRhdGFiYXNlV3JhcHBlci5nZXRDb25kaXRpb25Td2l0Y2hFbGVtZW50KHsgY29uY3JldGVEYXRhYmFzZTogZ3JhcGhJbnN0YW5jZS5kYXRhYmFzZSwgbm9kZUlEOiB0YXJnZXROb2RlLmlkZW50aXR5IH0pXG4gIGxldCB2YWx1ZSA9IGF3YWl0IHJlc29sdmVWYWx1ZSh7IHRhcmdldE5vZGU6IHRhcmdldE5vZGUsIGdyYXBoSW5zdGFuY2UsIHRyYXZlcnNlQ2FsbENvbnRleHQgfSlcbiAgLy8gU3dpdGNoIGNhc2VzOiByZXR1cm4gZXZhbHVhdGlvbiBjb25maWd1cmF0aW9uXG4gIGlmIChjYXNlQXJyYXkpIHtcbiAgICAvLyBjb21wYXJlIGV4cGVjdGVkIHZhbHVlIHdpdGggcmVzdWx0XG4gICAgbGV0IGNhc2VSZWxhdGlvbnNoaXAgPSBjYXNlQXJyYXkuZmlsdGVyKGNhc2VSZWxhdGlvbnNoaXAgPT4gY2FzZVJlbGF0aW9uc2hpcC5jb25uZWN0aW9uLnByb3BlcnRpZXM/LmV4cGVjdGVkID09IHZhbHVlKVswXVxuICAgIG1hdGNoaW5nTm9kZSA9IGNhc2VSZWxhdGlvbnNoaXA/LmRlc3RpbmF0aW9uXG4gIH1cbiAgcmV0dXJuIG1hdGNoaW5nTm9kZSB8fCBudWxsXG59XG4iXX0=