"use strict";Object.defineProperty(exports, "__esModule", { value: true });exports.resolveReference = resolveReference;exports.selectionReferenceResolution = selectionReferenceResolution;exports.conditionSwitchResolution = conditionSwitchResolution;var _valueResolution = require("./valueResolution.js");
var _concreteDatabaseWrapper = require("../dataModel/concreteDatabaseWrapper.js");


async function resolveReference({ targetNode, graphInstance, traverseCallContext }) {
  const { reference } = await graphInstance.databaseWrapper.getReferenceResolutionElement({ concreteDatabase: graphInstance.database, nodeID: targetNode.identity });
  if (!reference) return;


  if ((0, _concreteDatabaseWrapper.isSelfEdge)(reference)) {

    let labelIndex = reference.destination.labels.indexOf(targetNode.entrypointNodeType);
    reference.destination.labels[labelIndex] += `-ignore`;
  }

  let resolvedNode;
  switch (reference.connection.properties.resolutionImplementation) {
    case 'selection':
      resolvedNode = await selectionReferenceResolution({ graphInstance, targetNode: reference.destination, traverseCallContext });
      break;
    case 'node':
    default:
      resolvedNode = reference.destination;
      break;}


  return resolvedNode;
}




async function selectionReferenceResolution({ graphInstance, targetNode, traverseCallContext }) {
  let resolvedReferenceNode;
  const { selectArray, fallback: fallbackRelationship } = await graphInstance.databaseWrapper.getSelectionElement({ concreteDatabase: graphInstance.database, nodeID: targetNode.identity });
  selectArray.sort((former, latter) => former.connection.properties.order - latter.connection.properties.order);



  let index = 0;
  while (selectArray.length > index && !resolvedReferenceNode) {
    resolvedReferenceNode = await conditionSwitchResolution({ graphInstance, targetNode: selectArray[index].destination, traverseCallContext });
    index++;
  }

  resolvedReferenceNode || (resolvedReferenceNode = fallbackRelationship === null || fallbackRelationship === void 0 ? void 0 : fallbackRelationship.destination);
  return resolvedReferenceNode || null;
}





async function conditionSwitchResolution({ graphInstance, targetNode, traverseCallContext }) {
  let matchingNode;
  const { caseArray } = await graphInstance.databaseWrapper.getConditionSwitchElement({ concreteDatabase: graphInstance.database, nodeID: targetNode.identity });
  let value = await (0, _valueResolution.resolveValue)({ targetNode: targetNode, graphInstance, traverseCallContext });

  if (caseArray) {

    let caseRelationship = caseArray.filter(caseRelationship => {var _caseRelationship$con;return ((_caseRelationship$con = caseRelationship.connection.properties) === null || _caseRelationship$con === void 0 ? void 0 : _caseRelationship$con.expected) == value;})[0];
    matchingNode = caseRelationship === null || caseRelationship === void 0 ? void 0 : caseRelationship.destination;
  }
  return matchingNode || null;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NvdXJjZS90cmF2ZXJzZXJJbnN0cnVjdGlvbi9yZWZlcmVuY2VSZXNvbHV0aW9uLmpzIl0sIm5hbWVzIjpbInJlc29sdmVSZWZlcmVuY2UiLCJ0YXJnZXROb2RlIiwiZ3JhcGhJbnN0YW5jZSIsInRyYXZlcnNlQ2FsbENvbnRleHQiLCJyZWZlcmVuY2UiLCJkYXRhYmFzZVdyYXBwZXIiLCJnZXRSZWZlcmVuY2VSZXNvbHV0aW9uRWxlbWVudCIsImNvbmNyZXRlRGF0YWJhc2UiLCJkYXRhYmFzZSIsIm5vZGVJRCIsImlkZW50aXR5IiwibGFiZWxJbmRleCIsImRlc3RpbmF0aW9uIiwibGFiZWxzIiwiaW5kZXhPZiIsImVudHJ5cG9pbnROb2RlVHlwZSIsInJlc29sdmVkTm9kZSIsImNvbm5lY3Rpb24iLCJwcm9wZXJ0aWVzIiwicmVzb2x1dGlvbkltcGxlbWVudGF0aW9uIiwic2VsZWN0aW9uUmVmZXJlbmNlUmVzb2x1dGlvbiIsInJlc29sdmVkUmVmZXJlbmNlTm9kZSIsInNlbGVjdEFycmF5IiwiZmFsbGJhY2siLCJmYWxsYmFja1JlbGF0aW9uc2hpcCIsImdldFNlbGVjdGlvbkVsZW1lbnQiLCJzb3J0IiwiZm9ybWVyIiwibGF0dGVyIiwib3JkZXIiLCJpbmRleCIsImxlbmd0aCIsImNvbmRpdGlvblN3aXRjaFJlc29sdXRpb24iLCJtYXRjaGluZ05vZGUiLCJjYXNlQXJyYXkiLCJnZXRDb25kaXRpb25Td2l0Y2hFbGVtZW50IiwidmFsdWUiLCJjYXNlUmVsYXRpb25zaGlwIiwiZmlsdGVyIiwiZXhwZWN0ZWQiXSwibWFwcGluZ3MiOiJ5UEFBQTtBQUNBOzs7QUFHTyxlQUFlQSxnQkFBZixDQUFnQyxFQUFFQyxVQUFGLEVBQWNDLGFBQWQsRUFBNkJDLG1CQUE3QixFQUFoQyxFQUFvRjtBQUN6RixRQUFNLEVBQUVDLFNBQUYsS0FBZ0IsTUFBTUYsYUFBYSxDQUFDRyxlQUFkLENBQThCQyw2QkFBOUIsQ0FBNEQsRUFBRUMsZ0JBQWdCLEVB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QUFDSSxNQUFWLENBQWlCRCxnQkFBZ0Isc0NBQUksMEJBQUFBLGdCQUFnQixDQUFDcEIsVUFBakIsQ0FBNEJDLFVBQTVCLGdGQUF3Q3FCLFFBQXhDLEtBQW9ESCxLQUF4RCxFQUFqQyxFQUFnRyxDQUFoRyxDQUF2QjtBQUNBSCxJQUFBQSxZQUFZLEdBQUdJLGdCQUFILGFBQUdBLGdCQUFILHVCQUFHQSxnQkFBZ0IsQ0FBRXpCLFdBQWpDO0FBQ0Q7QUFDRCxTQUFPcUIsWUFBWSxJQUFJLElBQXZCO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyByZXNvbHZlVmFsdWUgfSBmcm9tICcuL3ZhbHVlUmVzb2x1dGlvbi5qcydcbmltcG9ydCB7IGlzU2VsZkVkZ2UgfSBmcm9tICcuLi9kYXRhTW9kZWwvY29uY3JldGVEYXRhYmFzZVdyYXBwZXIuanMnXG5cbi8vIFJlc29sdXRpb24gb2YgcmVmZXJlbmNlIG5vZGUgdXNpbmcgZGlmZmVyZW50IG1lY2hhbmlzbXMuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVzb2x2ZVJlZmVyZW5jZSh7IHRhcmdldE5vZGUsIGdyYXBoSW5zdGFuY2UsIHRyYXZlcnNlQ2FsbENvbnRleHQgfSkge1xuICBjb25zdCB7IHJlZmVyZW5jZSB9ID0gYXdhaXQgZ3JhcGhJbnN0YW5jZS5kYXRhYmFzZVdyYXBwZXIuZ2V0UmVmZXJlbmNlUmVzb2x1dGlvbkVsZW1lbnQoeyBjb25jcmV0ZURhdGFiYXNlOiBncmFwaEluc3RhbmNlLmRhdGFiYXNlLCBub2RlSUQ6IHRhcmdldE5vZGUuaWRlbnRpdHkgfSlcbiAgaWYgKCFyZWZlcmVuY2UpIHJldHVyblxuXG4gIC8vIHByZXZlbnQgY2lyY3VsYXIgdHJhdmVyc2FsLCBpbiBjYXNlIG11bHRpcGxlIHR5cGVzIGFyZSB1c2VkIGZvciB0aGUgc2FtZSBub2RlIGFuZCB0aGUgcmVmZXJlbmNlIGVkZ2UgaXMgc2VsZiBlZGdlOlxuICBpZiAoaXNTZWxmRWRnZShyZWZlcmVuY2UpKSB7XG4gICAgLy8gd29ya2Fyb3VuZCBpcyB0byByZW1vdmUgdGhlIFJlcm91dGUgdHlwZSBmcm9tIHRoZSBsYWJlbHMgYXJyYXkuIFRPRE86IGNvbnNpZGVyIGFsbG93aW5nIGEgcGFyYW1ldGVyIHRoYXQgY29udHJvbHMgd2hpY2ggZW50cnlwb2ludCBub2RlIGltcGxlbWVudGF0aW9ucyBhcmUgaWdub3JlZC5cbiAgICBsZXQgbGFiZWxJbmRleCA9IHJlZmVyZW5jZS5kZXN0aW5hdGlvbi5sYWJlbHMuaW5kZXhPZih0YXJnZXROb2RlLmVudHJ5cG9pbnROb2RlVHlwZSlcbiAgICByZWZlcmVuY2UuZGVzdGluYXRpb24ubGFiZWxzW2xhYmVsSW5kZXhdICs9IGAtaWdub3JlYCAvLyBpZ25vcmUgb24gbmV4dCB0cmF2ZXJzYWwgKGtlZXAgdGhlIGVudHJ5IGZvciBkZWJ1Z2dpbmcgcHVycG9zZXMpLlxuICB9XG5cbiAgbGV0IHJlc29sdmVkTm9kZVxuICBzd2l0Y2ggKHJlZmVyZW5jZS5jb25uZWN0aW9uLnByb3BlcnRpZXMucmVzb2x1dGlvbkltcGxlbWVudGF0aW9uKSB7XG4gICAgY2FzZSAnc2VsZWN0aW9uJzpcbiAgICAgIHJlc29sdmVkTm9kZSA9IGF3YWl0IHNlbGVjdGlvblJlZmVyZW5jZVJlc29sdXRpb24oeyBncmFwaEluc3RhbmNlLCB0YXJnZXROb2RlOiByZWZlcmVuY2UuZGVzdGluYXRpb24sIHRyYXZlcnNlQ2FsbENvbnRleHQgfSlcbiAgICAgIGJyZWFrXG4gICAgY2FzZSAnbm9kZSc6XG4gICAgZGVmYXVsdDpcbiAgICAgIHJlc29sdmVkTm9kZSA9IHJlZmVyZW5jZS5kZXN0aW5hdGlvblxuICAgICAgYnJlYWtcbiAgfVxuXG4gIHJldHVybiByZXNvbHZlZE5vZGVcbn1cblxuLyoqXG4gKiBDb250cm9sIGZsb3cgc3RydWN0dXJlIHN1cHBvcnRpbmcgYmluYXJ5IHNlbGVjYXRpb24gKGlmIHN0YXRlbWVudCksIGlmIGVsc2UgaWYsIHN3aXRjaCBjYXNlIChtdWx0aS13YXkgc2VsZWN0aW9uKS4gQSBjb21iaW5lZCBJZiBFbHNlIGFuZCBTd2l0Y2ggQ2FzZSBjb25jZXB0cy5cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNlbGVjdGlvblJlZmVyZW5jZVJlc29sdXRpb24oeyBncmFwaEluc3RhbmNlLCB0YXJnZXROb2RlLCB0cmF2ZXJzZUNhbGxDb250ZXh0IH0pIHtcbiAgbGV0IHJlc29sdmVkUmVmZXJlbmNlTm9kZVxuICBjb25zdCB7IHNlbGVjdEFycmF5LCBmYWxsYmFjazogZmFsbGJhY2tSZWxhdGlvbnNoaXAgfSA9IGF3YWl0IGdyYXBoSW5zdGFuY2UuZGF0YWJhc2VXcmFwcGVyLmdldFNlbGVjdGlvbkVsZW1lbnQoeyBjb25jcmV0ZURhdGFiYXNlOiBncmFwaEluc3RhbmNlLmRhdGFiYXNlLCBub2RlSUQ6IHRhcmdldE5vZGUuaWRlbnRpdHkgfSlcbiAgc2VsZWN0QXJyYXkuc29ydCgoZm9ybWVyLCBsYXR0ZXIpID0+IGZvcm1lci5jb25uZWN0aW9uLnByb3BlcnRpZXMub3JkZXIgLSBsYXR0ZXIuY29ubmVjdGlvbi5wcm9wZXJ0aWVzLm9yZGVyKSAvLyB1c2luZyBgb3JkZXJgIHByb3BlcnR5IC8vIEJ1bGsgYWN0aW9ucyBvbiBmb3JrcyAtIHNvcnQgZm9ya3NcblxuICAvLyBUT0RPOiBzdXBwb3J0IHBhcmFsbGVsIC8gcHJvbWlzZS5hbGwgc2VsZWN0aW9uIC0gd2hlcmUgdGhlIGZpcnN0IHNlbGVjdGVkIHdpbGwgYmUgcmV0dXJuZWQuIFdoZW4gU0VMRUNUIGhhcyBhbiBvcmRlciBpdCB3aWxsIGJlIGNocm9ub2xvZ2ljYWxseSBleGVjdXRlZCwgYnV0IHRoZSBzZWxlY3RzIHRoYXQgbGFjayBvcmRlciBwcm9wZXJ0eSB3aWxsIGJlIGV4ZWN1dGVkIHdpdGggcHJvbWlzZS5hbGxcbiAgLy8gVE9ETzogVXNlIHNhbWUgbG9naWMgaW4gcHJvcGFnYXRpb24gYXMgdXNlZCBmb3IgUG9ydCBORVhUIG5vZGVzLiAoY2hyb25vbG9naWNhbCwgcmFjZUZpcnN0UHJvbWlzZSwgYWxsUHJvbWlzZSwgZXRjLilcbiAgbGV0IGluZGV4ID0gMFxuICB3aGlsZSAoc2VsZWN0QXJyYXkubGVuZ3RoID4gaW5kZXggJiYgIXJlc29sdmVkUmVmZXJlbmNlTm9kZSkge1xuICAgIHJlc29sdmVkUmVmZXJlbmNlTm9kZSA9IGF3YWl0IGNvbmRpdGlvblN3aXRjaFJlc29sdXRpb24oeyBncmFwaEluc3RhbmNlLCB0YXJnZXROb2RlOiBzZWxlY3RBcnJheVtpbmRleF0uZGVzdGluYXRpb24sIHRyYXZlcnNlQ2FsbENvbnRleHQgfSlcbiAgICBpbmRleCsrXG4gIH1cblxuICByZXNvbHZlZFJlZmVyZW5jZU5vZGUgfHw9IGZhbGxiYWNrUmVsYXRpb25zaGlwPy5kZXN0aW5hdGlvblxuICByZXR1cm4gcmVzb2x2ZWRSZWZlcmVuY2VOb2RlIHx8IG51bGxcbn1cblxuLyoqIHJlc29sdmVzIFZBTFVFIGFuZCBwaWNrcyB0aGUgbWF0Y2hpbmcgQ0FTRSBub2RlLlxuICAqIEBwYXJhbSB0YXJnZXROb2RlIFN0YWdlIG5vZGUgd2l0aCBWQUxVRSBjb25uZWN0aW9uIHJlcHJlc2VudGluZyB0aGUgY29uZGl0aW9uXG5cbiovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY29uZGl0aW9uU3dpdGNoUmVzb2x1dGlvbih7IGdyYXBoSW5zdGFuY2UsIHRhcmdldE5vZGUsIHRyYXZlcnNlQ2FsbENvbnRleHQgfSkge1xuICBsZXQgbWF0Y2hpbmdOb2RlXG4gIGNvbnN0IHsgY2FzZUFycmF5IH0gPSBhd2FpdCBncmFwaEluc3RhbmNlLmRhdGFiYXNlV3JhcHBlci5nZXRDb25kaXRpb25Td2l0Y2hFbGVtZW50KHsgY29uY3JldGVEYXRhYmFzZTogZ3JhcGhJbnN0YW5jZS5kYXRhYmFzZSwgbm9kZUlEOiB0YXJnZXROb2RlLmlkZW50aXR5IH0pXG4gIGxldCB2YWx1ZSA9IGF3YWl0IHJlc29sdmVWYWx1ZSh7IHRhcmdldE5vZGU6IHRhcmdldE5vZGUsIGdyYXBoSW5zdGFuY2UsIHRyYXZlcnNlQ2FsbENvbnRleHQgfSlcbiAgLy8gU3dpdGNoIGNhc2VzOiByZXR1cm4gZXZhbHVhdGlvbiBjb25maWd1cmF0aW9uXG4gIGlmIChjYXNlQXJyYXkpIHtcbiAgICAvLyBjb21wYXJlIGV4cGVjdGVkIHZhbHVlIHdpdGggcmVzdWx0XG4gICAgbGV0IGNhc2VSZWxhdGlvbnNoaXAgPSBjYXNlQXJyYXkuZmlsdGVyKGNhc2VSZWxhdGlvbnNoaXAgPT4gY2FzZVJlbGF0aW9uc2hpcC5jb25uZWN0aW9uLnByb3BlcnRpZXM/LmV4cGVjdGVkID09IHZhbHVlKVswXVxuICAgIG1hdGNoaW5nTm9kZSA9IGNhc2VSZWxhdGlvbnNoaXA/LmRlc3RpbmF0aW9uXG4gIH1cbiAgcmV0dXJuIG1hdGNoaW5nTm9kZSB8fCBudWxsXG59XG4iXX0=