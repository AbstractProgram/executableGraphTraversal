"use strict";Object.defineProperty(exports, "__esModule", { value: true });exports.resolveReference = resolveReference;exports.selectionReferenceResolution = selectionReferenceResolution;exports.conditionSwitchResolution = conditionSwitchResolution;var _concreteDatabaseWrapper = require("../dataModel/concreteDatabaseWrapper.js");


async function resolveReference({ targetNode, graph, traverseCallContext }) {
  const { reference } = await graph.databaseWrapper.getReferenceResolutionElement({ concreteDatabase: graph.database, nodeID: targetNode.identity });
  if (!reference) return;


  if ((0, _concreteDatabaseWrapper.isSelfEdge)(reference)) {

    let labelIndex = reference.destination.labels.indexOf(targetNode.entrypointNodeType);
    reference.destination.labels[labelIndex] += `-ignore`;
  }

  let resolvedNode;
  switch (reference.connection.properties.resolutionImplementation) {
    case 'selection':
      resolvedNode = await graph.traverserInstruction.referenceResolution.selectionReferenceResolution({ graph, targetNode: reference.destination, traverseCallContext });
      break;
    case 'node':
    default:
      resolvedNode = reference.destination;
      break;}


  return resolvedNode;
}




async function selectionReferenceResolution({ graph, targetNode, traverseCallContext }) {
  let resolvedReferenceNode;
  const { selectArray, fallback: fallbackRelationship } = await graph.databaseWrapper.getSelectionElement({ concreteDatabase: graph.database, nodeID: targetNode.identity });
  selectArray.sort((former, latter) => former.connection.properties.order - latter.connection.properties.order);



  let index = 0;
  while (selectArray.length > index && !resolvedReferenceNode) {
    resolvedReferenceNode = await graph.traverserInstruction.referenceResolution.conditionSwitchResolution({ graph, targetNode: selectArray[index].destination, traverseCallContext });
    index++;
  }

  resolvedReferenceNode || (resolvedReferenceNode = fallbackRelationship === null || fallbackRelationship === void 0 ? void 0 : fallbackRelationship.destination);
  return resolvedReferenceNode || null;
}





async function conditionSwitchResolution({ graph, targetNode, traverseCallContext }) {
  let matchingNode;
  const { caseArray } = await graph.databaseWrapper.getConditionSwitchElement({ concreteDatabase: graph.database, nodeID: targetNode.identity });
  let value = await graph.traverserInstruction.valueResolution.resolveValue({ targetNode: targetNode, graph, traverseCallContext });

  if (caseArray) {

    let caseRelationship = caseArray.filter(caseRelationship => {var _caseRelationship$con;return ((_caseRelationship$con = caseRelationship.connection.properties) === null || _caseRelationship$con === void 0 ? void 0 : _caseRelationship$con.expected) == value;})[0];
    matchingNode = caseRelationship === null || caseRelationship === void 0 ? void 0 : caseRelationship.destination;
  }
  return matchingNode || null;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NvdXJjZS90cmF2ZXJzZXJJbnN0cnVjdGlvbi9yZWZlcmVuY2VSZXNvbHV0aW9uLmpzIl0sIm5hbWVzIjpbInJlc29sdmVSZWZlcmVuY2UiLCJ0YXJnZXROb2RlIiwiZ3JhcGgiLCJ0cmF2ZXJzZUNhbGxDb250ZXh0IiwicmVmZXJlbmNlIiwiZGF0YWJhc2VXcmFwcGVyIiwiZ2V0UmVmZXJlbmNlUmVzb2x1dGlvbkVsZW1lbnQiLCJjb25jcmV0ZURhdGFiYXNlIiwiZGF0YWJhc2UiLCJub2RlSUQiLCJpZGVudGl0eSIsImxhYmVsSW5kZXgiLCJkZXN0aW5hdGlvbiIsImxhYmVscyIsImluZGV4T2YiLCJlbnRyeXBvaW50Tm9kZVR5cGUiLCJyZXNvbHZlZE5vZGUiLCJjb25uZWN0aW9uIiwicHJvcGVydGllcyIsInJlc29sdXRpb25JbXBsZW1lbnRhdGlvbiIsInRyYXZlcnNlckluc3RydWN0aW9uIiwicmVmZXJlbmNlUmVzb2x1dGlvbiIsInNlbGVjdGlvblJlZmVyZW5jZVJlc29sdXRpb24iLCJyZXNvbHZlZFJlZmVyZW5jZU5vZGUiLCJzZWxlY3RBcnJheSIsImZhbGxiYWNrIiwiZmFsbGJhY2tSZWxhdGlvbnNoaXAiLCJnZXRTZWxlY3Rpb25FbGVtZW50Iiwic29ydCIsImZvcm1lciIsImxhdHRlciIsIm9yZGVyIiwiaW5kZXgiLCJsZW5ndGgiLCJjb25kaXRpb25Td2l0Y2hSZXNvbHV0aW9uIiwibWF0Y2hpbmdOb2RlIiwiY2FzZUFycmF5IiwiZ2V0Q29uZGl0aW9uU3dpdGNoRWxlbWVudCIsInZhbHVlIiwidmFsdWVSZXNvbHV0aW9uIiwicmVzb2x2ZVZhbHVlIiwiY2FzZVJlbGF0aW9uc2hpcCIsImZpbHRlciIsImV4cGVjdGVkIl0sIm1hcHBpbmdzIjoieVBBQUE7OztBQUdPLGVBQWVBLGdCQUFmLENBQWdDLEVBQUVDLFVBQUYsRUFBY0MsS0FBZCxFQUFxQkMsbUJBQXJCLEVBQWhDLEVBQTRFO0FBQ2pGLFFBQU0sRUFBRUMsU0FB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QUFJNEIsS0FBSyxHQUFHLE1BQU1wQyxLQUFLLENBQUNrQixvQkFBTixDQUEyQm1CLGVBQTNCLENBQTJDQyxZQUEzQyxDQUF3RCxFQUFFdkMsVUFBVSxFQUFFQSxVQUFkLEVBQTBCQyxLQUExQixFQUFpQ0MsbUJBQWpDLEVBQXhELENBQWxCOztBQUVBLE1BQUlpQyxTQUFKLEVBQWU7O0FBRWIsUUFBSUssZ0JBQWdCLEdBQUdMLFNBQVMsQ0FBQ00sTUFBVixDQUFpQkQsZ0JBQWdCLHNDQUFJLDBCQUFBQSxnQkFBZ0IsQ0FBQ3hCLFVBQWpCLENBQTRCQyxVQUE1QixnRkFBd0N5QixRQUF4QyxLQUFvREwsS0FBeEQsRUFBakMsRUFBZ0csQ0FBaEcsQ0FBdkI7QUFDQUgsSUFBQUEsWUFBWSxHQUFHTSxnQkFBSCxhQUFHQSxnQkFBSCx1QkFBR0EsZ0JBQWdCLENBQUU3QixXQUFqQztBQUNEO0FBQ0QsU0FBT3VCLFlBQVksSUFBSSxJQUF2QjtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaXNTZWxmRWRnZSB9IGZyb20gJy4uL2RhdGFNb2RlbC9jb25jcmV0ZURhdGFiYXNlV3JhcHBlci5qcydcblxuLy8gUmVzb2x1dGlvbiBvZiByZWZlcmVuY2Ugbm9kZSB1c2luZyBkaWZmZXJlbnQgbWVjaGFuaXNtcy5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZXNvbHZlUmVmZXJlbmNlKHsgdGFyZ2V0Tm9kZSwgZ3JhcGgsIHRyYXZlcnNlQ2FsbENvbnRleHQgfSkge1xuICBjb25zdCB7IHJlZmVyZW5jZSB9ID0gYXdhaXQgZ3JhcGguZGF0YWJhc2VXcmFwcGVyLmdldFJlZmVyZW5jZVJlc29sdXRpb25FbGVtZW50KHsgY29uY3JldGVEYXRhYmFzZTogZ3JhcGguZGF0YWJhc2UsIG5vZGVJRDogdGFyZ2V0Tm9kZS5pZGVudGl0eSB9KVxuICBpZiAoIXJlZmVyZW5jZSkgcmV0dXJuXG5cbiAgLy8gcHJldmVudCBjaXJjdWxhciB0cmF2ZXJzYWwsIGluIGNhc2UgbXVsdGlwbGUgdHlwZXMgYXJlIHVzZWQgZm9yIHRoZSBzYW1lIG5vZGUgYW5kIHRoZSByZWZlcmVuY2UgZWRnZSBpcyBzZWxmIGVkZ2U6XG4gIGlmIChpc1NlbGZFZGdlKHJlZmVyZW5jZSkpIHtcbiAgICAvLyB3b3JrYXJvdW5kIGlzIHRvIHJlbW92ZSB0aGUgUmVyb3V0ZSB0eXBlIGZyb20gdGhlIGxhYmVscyBhcnJheS4gVE9ETzogY29uc2lkZXIgYWxsb3dpbmcgYSBwYXJhbWV0ZXIgdGhhdCBjb250cm9scyB3aGljaCBlbnRyeXBvaW50IG5vZGUgaW1wbGVtZW50YXRpb25zIGFyZSBpZ25vcmVkLlxuICAgIGxldCBsYWJlbEluZGV4ID0gcmVmZXJlbmNlLmRlc3RpbmF0aW9uLmxhYmVscy5pbmRleE9mKHRhcmdldE5vZGUuZW50cnlwb2ludE5vZGVUeXBlKVxuICAgIHJlZmVyZW5jZS5kZXN0aW5hdGlvbi5sYWJlbHNbbGFiZWxJbmRleF0gKz0gYC1pZ25vcmVgIC8vIGlnbm9yZSBvbiBuZXh0IHRyYXZlcnNhbCAoa2VlcCB0aGUgZW50cnkgZm9yIGRlYnVnZ2luZyBwdXJwb3NlcykuXG4gIH1cblxuICBsZXQgcmVzb2x2ZWROb2RlXG4gIHN3aXRjaCAocmVmZXJlbmNlLmNvbm5lY3Rpb24ucHJvcGVydGllcy5yZXNvbHV0aW9uSW1wbGVtZW50YXRpb24pIHtcbiAgICBjYXNlICdzZWxlY3Rpb24nOlxuICAgICAgcmVzb2x2ZWROb2RlID0gYXdhaXQgZ3JhcGgudHJhdmVyc2VySW5zdHJ1Y3Rpb24ucmVmZXJlbmNlUmVzb2x1dGlvbi5zZWxlY3Rpb25SZWZlcmVuY2VSZXNvbHV0aW9uKHsgZ3JhcGgsIHRhcmdldE5vZGU6IHJlZmVyZW5jZS5kZXN0aW5hdGlvbiwgdHJhdmVyc2VDYWxsQ29udGV4dCB9KVxuICAgICAgYnJlYWtcbiAgICBjYXNlICdub2RlJzpcbiAgICBkZWZhdWx0OlxuICAgICAgcmVzb2x2ZWROb2RlID0gcmVmZXJlbmNlLmRlc3RpbmF0aW9uXG4gICAgICBicmVha1xuICB9XG5cbiAgcmV0dXJuIHJlc29sdmVkTm9kZVxufVxuXG4vKipcbiAqIENvbnRyb2wgZmxvdyBzdHJ1Y3R1cmUgc3VwcG9ydGluZyBiaW5hcnkgc2VsZWNhdGlvbiAoaWYgc3RhdGVtZW50KSwgaWYgZWxzZSBpZiwgc3dpdGNoIGNhc2UgKG11bHRpLXdheSBzZWxlY3Rpb24pLiBBIGNvbWJpbmVkIElmIEVsc2UgYW5kIFN3aXRjaCBDYXNlIGNvbmNlcHRzLlxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gc2VsZWN0aW9uUmVmZXJlbmNlUmVzb2x1dGlvbih7IGdyYXBoLCB0YXJnZXROb2RlLCB0cmF2ZXJzZUNhbGxDb250ZXh0IH0pIHtcbiAgbGV0IHJlc29sdmVkUmVmZXJlbmNlTm9kZVxuICBjb25zdCB7IHNlbGVjdEFycmF5LCBmYWxsYmFjazogZmFsbGJhY2tSZWxhdGlvbnNoaXAgfSA9IGF3YWl0IGdyYXBoLmRhdGFiYXNlV3JhcHBlci5nZXRTZWxlY3Rpb25FbGVtZW50KHsgY29uY3JldGVEYXRhYmFzZTogZ3JhcGguZGF0YWJhc2UsIG5vZGVJRDogdGFyZ2V0Tm9kZS5pZGVudGl0eSB9KVxuICBzZWxlY3RBcnJheS5zb3J0KChmb3JtZXIsIGxhdHRlcikgPT4gZm9ybWVyLmNvbm5lY3Rpb24ucHJvcGVydGllcy5vcmRlciAtIGxhdHRlci5jb25uZWN0aW9uLnByb3BlcnRpZXMub3JkZXIpIC8vIHVzaW5nIGBvcmRlcmAgcHJvcGVydHkgLy8gQnVsayBhY3Rpb25zIG9uIGZvcmtzIC0gc29ydCBmb3Jrc1xuXG4gIC8vIFRPRE86IHN1cHBvcnQgcGFyYWxsZWwgLyBwcm9taXNlLmFsbCBzZWxlY3Rpb24gLSB3aGVyZSB0aGUgZmlyc3Qgc2VsZWN0ZWQgd2lsbCBiZSByZXR1cm5lZC4gV2hlbiBTRUxFQ1QgaGFzIGFuIG9yZGVyIGl0IHdpbGwgYmUgY2hyb25vbG9naWNhbGx5IGV4ZWN1dGVkLCBidXQgdGhlIHNlbGVjdHMgdGhhdCBsYWNrIG9yZGVyIHByb3BlcnR5IHdpbGwgYmUgZXhlY3V0ZWQgd2l0aCBwcm9taXNlLmFsbFxuICAvLyBUT0RPOiBVc2Ugc2FtZSBsb2dpYyBpbiBwcm9wYWdhdGlvbiBhcyB1c2VkIGZvciBQb3J0IE5FWFQgbm9kZXMuIChjaHJvbm9sb2dpY2FsLCByYWNlRmlyc3RQcm9taXNlLCBhbGxQcm9taXNlLCBldGMuKVxuICBsZXQgaW5kZXggPSAwXG4gIHdoaWxlIChzZWxlY3RBcnJheS5sZW5ndGggPiBpbmRleCAmJiAhcmVzb2x2ZWRSZWZlcmVuY2VOb2RlKSB7XG4gICAgcmVzb2x2ZWRSZWZlcmVuY2VOb2RlID0gYXdhaXQgZ3JhcGgudHJhdmVyc2VySW5zdHJ1Y3Rpb24ucmVmZXJlbmNlUmVzb2x1dGlvbi5jb25kaXRpb25Td2l0Y2hSZXNvbHV0aW9uKHsgZ3JhcGgsIHRhcmdldE5vZGU6IHNlbGVjdEFycmF5W2luZGV4XS5kZXN0aW5hdGlvbiwgdHJhdmVyc2VDYWxsQ29udGV4dCB9KVxuICAgIGluZGV4KytcbiAgfVxuXG4gIHJlc29sdmVkUmVmZXJlbmNlTm9kZSB8fD0gZmFsbGJhY2tSZWxhdGlvbnNoaXA/LmRlc3RpbmF0aW9uXG4gIHJldHVybiByZXNvbHZlZFJlZmVyZW5jZU5vZGUgfHwgbnVsbFxufVxuXG4vKiogcmVzb2x2ZXMgVkFMVUUgYW5kIHBpY2tzIHRoZSBtYXRjaGluZyBDQVNFIG5vZGUuXG4gICogQHBhcmFtIHRhcmdldE5vZGUgU3RhZ2Ugbm9kZSB3aXRoIFZBTFVFIGNvbm5lY3Rpb24gcmVwcmVzZW50aW5nIHRoZSBjb25kaXRpb25cblxuKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjb25kaXRpb25Td2l0Y2hSZXNvbHV0aW9uKHsgZ3JhcGgsIHRhcmdldE5vZGUsIHRyYXZlcnNlQ2FsbENvbnRleHQgfSkge1xuICBsZXQgbWF0Y2hpbmdOb2RlXG4gIGNvbnN0IHsgY2FzZUFycmF5IH0gPSBhd2FpdCBncmFwaC5kYXRhYmFzZVdyYXBwZXIuZ2V0Q29uZGl0aW9uU3dpdGNoRWxlbWVudCh7IGNvbmNyZXRlRGF0YWJhc2U6IGdyYXBoLmRhdGFiYXNlLCBub2RlSUQ6IHRhcmdldE5vZGUuaWRlbnRpdHkgfSlcbiAgbGV0IHZhbHVlID0gYXdhaXQgZ3JhcGgudHJhdmVyc2VySW5zdHJ1Y3Rpb24udmFsdWVSZXNvbHV0aW9uLnJlc29sdmVWYWx1ZSh7IHRhcmdldE5vZGU6IHRhcmdldE5vZGUsIGdyYXBoLCB0cmF2ZXJzZUNhbGxDb250ZXh0IH0pXG4gIC8vIFN3aXRjaCBjYXNlczogcmV0dXJuIGV2YWx1YXRpb24gY29uZmlndXJhdGlvblxuICBpZiAoY2FzZUFycmF5KSB7XG4gICAgLy8gY29tcGFyZSBleHBlY3RlZCB2YWx1ZSB3aXRoIHJlc3VsdFxuICAgIGxldCBjYXNlUmVsYXRpb25zaGlwID0gY2FzZUFycmF5LmZpbHRlcihjYXNlUmVsYXRpb25zaGlwID0+IGNhc2VSZWxhdGlvbnNoaXAuY29ubmVjdGlvbi5wcm9wZXJ0aWVzPy5leHBlY3RlZCA9PSB2YWx1ZSlbMF1cbiAgICBtYXRjaGluZ05vZGUgPSBjYXNlUmVsYXRpb25zaGlwPy5kZXN0aW5hdGlvblxuICB9XG4gIHJldHVybiBtYXRjaGluZ05vZGUgfHwgbnVsbFxufVxuIl19