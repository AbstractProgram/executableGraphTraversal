"use strict";var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports, "__esModule", { value: true });exports.evaluateCondition = evaluateCondition;var _graphSchemeReference = require("../../../graphSchemeReference.js");
var _assert = _interopRequireDefault(require("assert"));
var _EvaluatorClass = require("../../../constructable/Evaluator.class.js");

async function evaluateCondition({ evaluation, node, graphInstance }) {
  let configureRelationshipArray = await graphInstance.database.getNodeConnection({ direction: 'incoming', nodeID: node.identity, connectionType: _graphSchemeReference.connectionType.configure });

  for (let configureRelationship of configureRelationshipArray) {
    let configureNode = configureRelationship.destination;


    let nodeEvaluationConfig = {};
    if (configureNode.labels.includes(_graphSchemeReference.nodeLabel.configuration)) {
      nodeEvaluationConfig = extractEvaluationConfigProperty(configureNode.properties);
    } else if (configureNode.labels.includes(_graphSchemeReference.nodeLabel.evaluation)) {
      nodeEvaluationConfig = await checkEvaluationNode({ evaluationNode: configureNode, graphInstance });
    } else throw new Error(`• "${configureNode.labels}" Unsupported node type for a NEXT connection.`);

    Object.assign(evaluation, nodeEvaluationConfig);
  }
}

async function checkEvaluationNode({ evaluationNode, graphInstance }) {
  let caseRelationshipArray = await graphInstance.database.getNodeConnection({ direction: 'outgoing', nodeID: evaluationNode.identity, connectionType: _graphSchemeReference.connectionType.case });
  let defaultRelationshipArray = await graphInstance.database.getNodeConnection({ direction: 'outgoing', nodeID: evaluationNode.identity, connectionType: _graphSchemeReference.connectionType.default });
  let executeRelationshipArray = await graphInstance.database.getNodeConnection({ direction: 'outgoing', nodeID: evaluationNode.identity, connectionType: _graphSchemeReference.connectionType.execute });


  let checkResult;
  if (executeRelationshipArray.length > 0) {
    let executeNode = executeRelationshipArray[0].destination;


    checkResult = undefined;
  } else {var _evaluationNode$prope;
    checkResult = ((_evaluationNode$prope = evaluationNode.properties) === null || _evaluationNode$prope === void 0 ? void 0 : _evaluationNode$prope.switchValue) || undefined;
  }
  caseRelationshipArray = caseRelationshipArray.filter(caseRelationship => {var _caseRelationship$con;return ((_caseRelationship$con = caseRelationship.connection.properties) === null || _caseRelationship$con === void 0 ? void 0 : _caseRelationship$con.expected) == checkResult;});


  if (caseRelationshipArray.length > 0) {
    let caseNode = caseRelationshipArray[0].destination;
    (0, _assert.default)(caseNode.labels.includes(_graphSchemeReference.nodeLabel.configuration), `• "${caseNode.labels}" Unsupported node type for a NEXT connection.`);
    return extractEvaluationConfigProperty(caseNode.properties);
  } else {
    let defaultNode = defaultRelationshipArray[0].destination;
    (0, _assert.default)(defaultNode.labels.includes(_graphSchemeReference.nodeLabel.configuration), `• "${defaultNode.labels}" Unsupported node type for a NEXT connection.`);
    return extractEvaluationConfigProperty(defaultNode.properties);
  }
}

function extractEvaluationConfigProperty(propertyObject) {
  return Object.entries(propertyObject).reduce((accumulator, [key, value]) => {
    if (Object.keys(_EvaluatorClass.evaluationOption).includes(key)) accumulator[key] = value;
    return accumulator;
  }, {});
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NvdXJjZS9pbXBsZW1lbnRhdGlvblBsdWdpbi9ncmFwaFRyYXZlcnNhbEltcGxlbWVudGF0aW9uL2NvbmNyZXRlRnVuY3Rpb24vZXZhbHVhdGVQb3NpdGlvbi5qcyJdLCJuYW1lcyI6WyJldmFsdWF0ZUNvbmRpdGlvbiIsImV2YWx1YXRpb24iLCJub2RlIiwiZ3JhcGhJbnN0YW5jZSIsImNvbmZpZ3VyZVJlbGF0aW9uc2hpcEFycmF5IiwiZGF0YWJhc2UiLCJnZXROb2RlQ29ubmVjdGlvbiIsImRpcmVjdGlvbiIsIm5vZGVJRCIsImlkZW50aXR5IiwiY29ubmVjdGlvblR5cGUiLCJjb25maWd1cmUiLCJjb25maWd1cmVSZWxhdGlvbnNoaXAiLCJjb25maWd1cmVOb2RlIiwiZGVzdGluYXRpb24iLCJub2RlRXZhbHVhdGlvbkNvbmZpZyIsImxhYmVscyIsImluY2x1ZGVzIiwibm9kZUxhYmVsIiwiY29uZmlndXJhdGlvbiIsImV4dHJhY3RFdmFsdWF0aW9uQ29uZmlnUHJvcGVydHkiLCJwcm9wZXJ0aWVzIiwiY2hlY2tFdmFsdWF0aW9uTm9kZSIsImV2YWx1YXRpb25Ob2RlIiwiRXJyb3IiLCJPYmplY3QiLCJhc3NpZ24iLCJjYXNlUmVsYXRpb25zaGlwQXJyYXkiLCJjYXNlIiwiZGVmYXVsdFJlbGF0aW9uc2hpcEFycmF5IiwiZGVmYXVsdCIsImV4ZWN1dGVSZWxhdGlvbnNoaXBBcnJheSIsImV4ZWN1dGUiLCJjaGVja1Jlc3VsdCIsImxlbmd0aCIsImV4ZWN1dGVOb2RlIiwidW5kZWZpbmVkIiwic3dpdGNoVmFsdWUiLCJmaWx0ZXIiLCJjYXNlUmVsYXRpb25zaGlwIiwiY29ubmVjdGlvbiIsImV4cGVjdGVkIiwiY2FzZU5vZGUiLCJkZWZhdWx0Tm9kZSIsInByb3BlcnR5T2JqZWN0IiwiZW50cmllcyIsInJlZHVjZSIsImFjY3VtdWxhdG9yIiwia2V5IiwidmFsdWUiLCJrZXlzIiwiZXZhbHVhdGlvbk9wdGlvbiJdLCJtYXBw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QixHQUErQixDQUFuQyxFQUFzQztBQUNwQyxRQUFJUSxRQUFRLEdBQUdmLHFCQUFxQixDQUFDLENBQUQsQ0FBckIsQ0FBeUJiLFdBQXhDO0FBQ0EseUJBQU80QixRQUFRLENBQUMxQixNQUFULENBQWdCQyxRQUFoQixDQUF5QkMsZ0NBQVVDLGFBQW5DLENBQVAsRUFBMkQsTUFBS3VCLFFBQVEsQ0FBQzFCLE1BQU8sZ0RBQWhGO0FBQ0EsV0FBT0ksK0JBQStCLENBQUNzQixRQUFRLENBQUNyQixVQUFWLENBQXRDO0FBQ0QsR0FKRCxNQUlPO0FBQ0wsUUFBSXNCLFdBQVcsR0FBR2Qsd0JBQXdCLENBQUMsQ0FBRCxDQUF4QixDQUE0QmYsV0FBOUM7QUFDQSx5QkFBTzZCLFdBQVcsQ0FBQzNCLE1BQVosQ0FBbUJDLFFBQW5CLENBQTRCQyxnQ0FBVUMsYUFBdEMsQ0FBUCxFQUE4RCxNQUFLd0IsV0FBVyxDQUFDM0IsTUFBTyxnREFBdEY7QUFDQSxXQUFPSSwrQkFBK0IsQ0FBQ3VCLFdBQVcsQ0FBQ3RCLFVBQWIsQ0FBdEM7QUFDRDtBQUNGOztBQUVELFNBQVNELCtCQUFULENBQXlDd0IsY0FBekMsRUFBeUQ7QUFDdkQsU0FBT25CLE1BQU0sQ0FBQ29CLE9BQVAsQ0FBZUQsY0FBZixFQUErQkUsTUFBL0IsQ0FBc0MsQ0FBQ0MsV0FBRCxFQUFjLENBQUNDLEdBQUQsRUFBTUMsS0FBTixDQUFkLEtBQStCO0FBQzFFLFFBQUl4QixNQUFNLENBQUN5QixJQUFQLENBQVlDLGdDQUFaLEVBQThCbEMsUUFBOUIsQ0FBdUMrQixHQUF2QyxDQUFKLEVBQWlERCxXQUFXLENBQUNDLEdBQUQsQ0FBWCxHQUFtQkMsS0FBbkI7QUFDakQsV0FBT0YsV0FBUDtBQUNELEdBSE0sRUFHSixFQUhJLENBQVA7QUFJRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNvbm5lY3Rpb25UeXBlLCBub2RlTGFiZWwgfSBmcm9tICcuLi8uLi8uLi9ncmFwaFNjaGVtZVJlZmVyZW5jZS5qcydcbmltcG9ydCBhc3NlcnQgZnJvbSAnYXNzZXJ0J1xuaW1wb3J0IHsgZXZhbHVhdGlvbk9wdGlvbiB9IGZyb20gJy4uLy4uLy4uL2NvbnN0cnVjdGFibGUvRXZhbHVhdG9yLmNsYXNzLmpzJ1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZXZhbHVhdGVDb25kaXRpb24oeyBldmFsdWF0aW9uLCBub2RlLCBncmFwaEluc3RhbmNlIH0pIHtcbiAgbGV0IGNvbmZpZ3VyZVJlbGF0aW9uc2hpcEFycmF5ID0gYXdhaXQgZ3JhcGhJbnN0YW5jZS5kYXRhYmFzZS5nZXROb2RlQ29ubmVjdGlvbih7IGRpcmVjdGlvbjogJ2luY29taW5nJywgbm9kZUlEOiBub2RlLmlkZW50aXR5LCBjb25uZWN0aW9uVHlwZTogY29ubmVjdGlvblR5cGUuY29uZmlndXJlIH0pXG5cbiAgZm9yIChsZXQgY29uZmlndXJlUmVsYXRpb25zaGlwIG9mIGNvbmZpZ3VyZVJlbGF0aW9uc2hpcEFycmF5KSB7XG4gICAgbGV0IGNvbmZpZ3VyZU5vZGUgPSBjb25maWd1cmVSZWxhdGlvbnNoaXAuZGVzdGluYXRpb25cblxuICAgIC8vIHZlcmlmeSAmIHN3aXRjaCBub2RlIHR5cGVcbiAgICBsZXQgbm9kZUV2YWx1YXRpb25Db25maWcgPSB7fVxuICAgIGlmIChjb25maWd1cmVOb2RlLmxhYmVscy5pbmNsdWRlcyhub2RlTGFiZWwuY29uZmlndXJhdGlvbikpIHtcbiAgICAgIG5vZGVFdmFsdWF0aW9uQ29uZmlnID0gZXh0cmFjdEV2YWx1YXRpb25Db25maWdQcm9wZXJ0eShjb25maWd1cmVOb2RlLnByb3BlcnRpZXMpXG4gICAgfSBlbHNlIGlmIChjb25maWd1cmVOb2RlLmxhYmVscy5pbmNsdWRlcyhub2RlTGFiZWwuZXZhbHVhdGlvbikpIHtcbiAgICAgIG5vZGVFdmFsdWF0aW9uQ29uZmlnID0gYXdhaXQgY2hlY2tFdmFsdWF0aW9uTm9kZSh7IGV2YWx1YXRpb25Ob2RlOiBjb25maWd1cmVOb2RlLCBncmFwaEluc3RhbmNlIH0pXG4gICAgfSBlbHNlIHRocm93IG5ldyBFcnJvcihg4oCiIFwiJHtjb25maWd1cmVOb2RlLmxhYmVsc31cIiBVbnN1cHBvcnRlZCBub2RlIHR5cGUgZm9yIGEgTkVYVCBjb25uZWN0aW9uLmApXG5cbiAgICBPYmplY3QuYXNzaWduKGV2YWx1YXRpb24sIG5vZGVFdmFsdWF0aW9uQ29uZmlnKVxuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNoZWNrRXZhbHVhdGlvbk5vZGUoeyBldmFsdWF0aW9uTm9kZSwgZ3JhcGhJbnN0YW5jZSB9KSB7XG4gIGxldCBjYXNlUmVsYXRpb25zaGlwQXJyYXkgPSBhd2FpdCBncmFwaEluc3RhbmNlLmRhdGFiYXNlLmdldE5vZGVDb25uZWN0aW9uKHsgZGlyZWN0aW9uOiAnb3V0Z29pbmcnLCBub2RlSUQ6IGV2YWx1YXRpb25Ob2RlLmlkZW50aXR5LCBjb25uZWN0aW9uVHlwZTogY29ubmVjdGlvblR5cGUuY2FzZSB9KVxuICBsZXQgZGVmYXVsdFJlbGF0aW9uc2hpcEFycmF5ID0gYXdhaXQgZ3JhcGhJbnN0YW5jZS5kYXRhYmFzZS5nZXROb2RlQ29ubmVjdGlvbih7IGRpcmVjdGlvbjogJ291dGdvaW5nJywgbm9kZUlEOiBldmFsdWF0aW9uTm9kZS5pZGVudGl0eSwgY29ubmVjdGlvblR5cGU6IGNvbm5lY3Rpb25UeXBlLmRlZmF1bHQgfSlcbiAgbGV0IGV4ZWN1dGVSZWxhdGlvbnNoaXBBcnJheSA9IGF3YWl0IGdyYXBoSW5zdGFuY2UuZGF0YWJhc2UuZ2V0Tm9kZUNvbm5lY3Rpb24oeyBkaXJlY3Rpb246ICdvdXRnb2luZycsIG5vZGVJRDogZXZhbHVhdGlvbk5vZGUuaWRlbnRpdHksIGNvbm5lY3Rpb25UeXBlOiBjb25uZWN0aW9uVHlwZS5leGVjdXRlIH0pXG5cbiAgLy8gcnVuIGNvbmRpdGlvbiBjaGVja1xuICBsZXQgY2hlY2tSZXN1bHRcbiAgaWYgKGV4ZWN1dGVSZWxhdGlvbnNoaXBBcnJheS5sZW5ndGggPiAwKSB7XG4gICAgbGV0IGV4ZWN1dGVOb2RlID0gZXhlY3V0ZVJlbGF0aW9uc2hpcEFycmF5WzBdLmRlc3RpbmF0aW9uXG4gICAgLy8gVE9ETzogZXhlY3V0ZSBjaGVrIHByb2Nlc3MgdG8gcmV0cmlldmUgY2hlY2tSZXN1bHQuXG4gICAgLy8gVE9ETzogYXBwbHkgUlVOIG9uIHN1YmdyYXBoIG9mIGNvbmRpdGlvbnMuXG4gICAgY2hlY2tSZXN1bHQgPSB1bmRlZmluZWQgLy8gZXhlY3V0ZSBwcm9jZXNzXG4gIH0gZWxzZSB7XG4gICAgY2hlY2tSZXN1bHQgPSBldmFsdWF0aW9uTm9kZS5wcm9wZXJ0aWVzPy5zd2l0Y2hWYWx1ZSB8fCB1bmRlZmluZWRcbiAgfVxuICBjYXNlUmVsYXRpb25zaGlwQXJyYXkgPSBjYXNlUmVsYXRpb25zaGlwQXJyYXkuZmlsdGVyKGNhc2VSZWxhdGlvbnNoaXAgPT4gY2FzZVJlbGF0aW9uc2hpcC5jb25uZWN0aW9uLnByb3BlcnRpZXM/LmV4cGVjdGVkID09IGNoZWNrUmVzdWx0KVxuXG4gIC8vIHJldHVybiBldmFsdWF0aW9uIGNvbmZpZ3VyYXRpb25cbiAgaWYgKGNhc2VSZWxhdGlvbnNoaXBBcnJheS5sZW5ndGggPiAwKSB7XG4gICAgbGV0IGNhc2VOb2RlID0gY2FzZVJlbGF0aW9uc2hpcEFycmF5WzBdLmRlc3RpbmF0aW9uXG4gICAgYXNzZXJ0KGNhc2VOb2RlLmxhYmVscy5pbmNsdWRlcyhub2RlTGFiZWwuY29uZmlndXJhdGlvbiksIGDigKIgXCIke2Nhc2VOb2RlLmxhYmVsc31cIiBVbnN1cHBvcnRlZCBub2RlIHR5cGUgZm9yIGEgTkVYVCBjb25uZWN0aW9uLmApIC8vIHZlcmlmeSBub2RlIHR5cGVcbiAgICByZXR1cm4gZXh0cmFjdEV2YWx1YXRpb25Db25maWdQcm9wZXJ0eShjYXNlTm9kZS5wcm9wZXJ0aWVzKVxuICB9IGVsc2Uge1xuICAgIGxldCBkZWZhdWx0Tm9kZSA9IGRlZmF1bHRSZWxhdGlvbnNoaXBBcnJheVswXS5kZXN0aW5hdGlvblxuICAgIGFzc2VydChkZWZhdWx0Tm9kZS5sYWJlbHMuaW5jbHVkZXMobm9kZUxhYmVsLmNvbmZpZ3VyYXRpb24pLCBg4oCiIFwiJHtkZWZhdWx0Tm9kZS5sYWJlbHN9XCIgVW5zdXBwb3J0ZWQgbm9kZSB0eXBlIGZvciBhIE5FWFQgY29ubmVjdGlvbi5gKSAvLyB2ZXJpZnkgbm9kZSB0eXBlXG4gICAgcmV0dXJuIGV4dHJhY3RFdmFsdWF0aW9uQ29uZmlnUHJvcGVydHkoZGVmYXVsdE5vZGUucHJvcGVydGllcylcbiAgfVxufVxuXG5mdW5jdGlvbiBleHRyYWN0RXZhbHVhdGlvbkNvbmZpZ1Byb3BlcnR5KHByb3BlcnR5T2JqZWN0KSB7XG4gIHJldHVybiBPYmplY3QuZW50cmllcyhwcm9wZXJ0eU9iamVjdCkucmVkdWNlKChhY2N1bXVsYXRvciwgW2tleSwgdmFsdWVdKSA9PiB7XG4gICAgaWYgKE9iamVjdC5rZXlzKGV2YWx1YXRpb25PcHRpb24pLmluY2x1ZGVzKGtleSkpIGFjY3VtdWxhdG9yW2tleV0gPSB2YWx1ZVxuICAgIHJldHVybiBhY2N1bXVsYXRvclxuICB9LCB7fSlcbn1cbiJdfQ==